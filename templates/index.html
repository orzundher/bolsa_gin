<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Inversiones</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/static/img/favicon.png">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Flowbite CSS -->
    <link href="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.css" rel="stylesheet" />
    <link href="/static/css/common.css" rel="stylesheet">
</head>

<body class="bg-gray-50 dark:bg-gray-900">
    {{template "header" .}}
    
    <div class="p-4 sm:ml-64">
        <div class="p-4 mt-14">

        <!-- Metrics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-6 gap-6 mb-8">
            <!-- Número de Posiciones -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h4 class="text-lg font-medium text-gray-500 dark:text-gray-400 mb-2">Posiciones</h4>
                <h3 class="text-3xl font-bold text-blue-600 dark:text-blue-400">{{.NumPositions}}</h3>
            </div>

            <!-- Costos de Operación -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h4 class="text-lg font-medium text-gray-500 dark:text-gray-400 mb-2">Costos de Operación</h4>
                <h3 class="text-3xl font-bold text-gray-600 dark:text-gray-300">{{printf "%.3f€" .TotalOperationCost}}</h3>
            </div>

            <!-- Utilidad Ventas -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h4 class="text-lg font-medium text-gray-500 dark:text-gray-400 mb-2">Utilidad Ventas</h4>
                <h3 class="text-3xl font-bold {{if ge .TotalSaleUtility 0.0}}text-green-600 dark:text-green-400{{else}}text-red-600 dark:text-red-400{{end}}">
                    {{if ge .TotalSaleUtility 0.0}}+{{end}}{{printf "%.2f€" .TotalSaleUtility}}
                </h3>
            </div>

            <!-- Rendimiento Cartera -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h4 class="text-lg font-medium text-gray-500 dark:text-gray-400 mb-2">Rendimiento Cartera</h4>
                <h3 class="text-3xl font-bold {{if ge .PortfolioPerformance 0.0}}text-green-600 dark:text-green-400{{else}}text-red-600 dark:text-red-400{{end}}">
                    {{if ge .PortfolioPerformance 0.0}}+{{end}}{{printf "%.2f%%" .PortfolioPerformance}}
                </h3>
            </div>

            <!-- Utilidad Cartera -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h4 class="text-lg font-medium text-gray-500 dark:text-gray-400 mb-2">Utilidad Cartera</h4>
                <h3 class="text-3xl font-bold {{if ge .PortfolioUtility 0.0}}text-green-600 dark:text-green-400{{else}}text-red-600 dark:text-red-400{{end}}">
                    {{if ge .PortfolioUtility 0.0}}+{{end}}{{printf "%.2f€" .PortfolioUtility}}
                </h3>
            </div>

            <!-- Valor de Salida -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h4 class="text-lg font-medium text-gray-500 dark:text-gray-400 mb-2">Valor de Salida</h4>
                <h3 class="text-3xl font-bold {{if ge .ExitValue 0.0}}text-green-600 dark:text-green-400{{else}}text-red-600 dark:text-red-400{{end}}">
                    {{if ge .ExitValue 0.0}}+{{end}}{{printf "%.2f€" .ExitValue}}
                </h3>
            </div>
        </div>

        <!-- Gráfico de Evolución de Utilidad de la Cartera -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-8 p-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Evolución de Utilidad de la Cartera</h2>
            <div id="portfolioUtilityChart"></div>
        </div>

        </div>

        <!-- Notes Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-8 p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Anotaciones y Recordatorios</h2>
                <button type="button" onclick="openAddNoteModal()" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
                    Nueva Nota
                </button>
            </div>
            
            <div class="overflow-x-auto">
                {{if .Notes}}
                <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                        <tr>
                            <th scope="col" class="px-6 py-3 w-32">Fecha</th>
                            <th scope="col" class="px-6 py-3">Nota</th>
                            <th scope="col" class="px-6 py-3 w-24 text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .Notes}}
                        <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                            <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900 dark:text-white">
                                {{.Date.Format "02 Jan 2006"}}
                            </td>
                            <td class="px-6 py-4">
                                {{.Content}}
                            </td>
                            <td class="px-6 py-4 flex justify-center space-x-2">
                                <button onclick="openEditNoteModal({{.ID}}, '{{.Date.Format "2006-01-02"}}', '{{.Content}}')" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                </button>
                                <button onclick="deleteNote({{.ID}})" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
                {{else}}
                <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                    <p>No hay notas guardadas.</p>
                </div>
                {{end}}
            </div>
        </div>

    </div>
    
    <!-- Note Modal -->
    <div id="noteModal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
        <div class="relative p-4 w-full max-w-md max-h-full">
            <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
                <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600">
                    <h3 id="modalTitle" class="text-xl font-semibold text-gray-900 dark:text-white">
                        Nueva Nota
                    </h3>
                    <button type="button" onclick="closeNoteModal()" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white">
                        <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                        </svg>
                        <span class="sr-only">Cerrar modal</span>
                    </button>
                </div>
                <form id="noteForm" onsubmit="handleNoteSubmit(event)">
                    <input type="hidden" id="noteId">
                    <div class="p-4 md:p-5">
                        <div class="grid gap-4 mb-4 grid-cols-2">
                            <div class="col-span-2">
                                <label for="noteDate" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Fecha</label>
                                <input type="date" name="date" id="noteDate" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500" required="">
                            </div>
                            <div class="col-span-2">
                                <label for="noteContent" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Contenido</label>
                                <textarea id="noteContent" rows="4" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="Escribe tu nota aquí..." required></textarea>
                            </div>
                        </div>
                        <button type="submit" class="text-white inline-flex items-center bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
                            <svg class="me-1 -ms-1 w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
                            Guardar Nota
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!-- Flowbite JS -->
    <script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.js"></script>
    <script src="/static/js/table-sort.js"></script>
    <script src="/static/js/home.js"></script>

    <script>
        // Funciones para gestión de notas
        let noteModal;
        
        document.addEventListener('DOMContentLoaded', function() {
            const modalEl = document.getElementById('noteModal');
            if (modalEl) {
                noteModal = new Modal(modalEl);
            }
        });

        function openAddNoteModal() {
            document.getElementById('modalTitle').textContent = 'Nueva Nota';
            document.getElementById('noteForm').reset();
            document.getElementById('noteId').value = '';
            document.getElementById('noteDate').valueAsDate = new Date();
            noteModal.show();
        }

        function openEditNoteModal(id, date, content) {
            document.getElementById('modalTitle').textContent = 'Editar Nota';
            document.getElementById('noteId').value = id;
            document.getElementById('noteDate').value = date;
            document.getElementById('noteContent').value = content;
            noteModal.show();
        }

        function closeNoteModal() {
            noteModal.hide();
        }

        async function handleNoteSubmit(event) {
            event.preventDefault();
            
            const id = document.getElementById('noteId').value;
            const date = document.getElementById('noteDate').value;
            const content = document.getElementById('noteContent').value;
            
            const url = id ? `/api/notes/${id}` : '/api/notes';
            const method = id ? 'PUT' : 'POST';
            
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ date, content }),
                });

                if (response.ok) {
                    window.location.reload();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error || 'No se pudo guardar la nota'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ocurrió un error al procesar la solicitud');
            }
        }

        async function deleteNote(id) {
            if (!confirm('¿Estás seguro de que quieres eliminar esta nota?')) {
                return;
            }

            try {
                const response = await fetch(`/api/notes/${id}`, {
                    method: 'DELETE',
                });

                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('Error al eliminar la nota');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ocurrió un error al intentar eliminar la nota');
            }
        }

        // Cargar datos del historial de utilidad de la cartera
        fetch('/api/portfolio-utility-history')
            .then(response => response.json())
            .then(data => {
                if (data.dates.length === 0) {
                    document.getElementById('portfolioUtilityChart').innerHTML = 
                        '<p class="text-center text-gray-500 dark:text-gray-400 py-8">No hay snapshots disponibles para mostrar el gráfico</p>';
                    return;
                }

                // Función para convertir fecha "DD Mon YYYY HH:MM" a timestamp
                function parseDate(dateStr) {
                    try {
                        const months = {
                            'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
                            'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
                        };
                        const parts = dateStr.split(' ');
                        if (parts.length < 4) {
                            console.error('Invalid date format:', dateStr);
                            return null;
                        }
                        const day = parseInt(parts[0]);
                        const month = months[parts[1]];
                        const year = parseInt(parts[2]);
                        const time = parts[3] ? parts[3].split(':') : ['0', '0'];
                        const hour = parseInt(time[0]);
                        const minute = parseInt(time[1]);
                        
                        if (isNaN(day) || month === undefined || isNaN(year) || isNaN(hour) || isNaN(minute)) {
                            console.error('Invalid date components:', {dateStr, day, month, year, hour, minute});
                            return null;
                        }
                        
                        return new Date(year, month, day, hour, minute).getTime();
                    } catch (error) {
                        console.error('Error parsing date:', dateStr, error);
                        return null;
                    }
                }

                // Preparar datos para el gráfico
                const chartData = data.dates.map((date, index) => ({
                    x: parseDate(date),
                    y: data.utilities[index]
                })).filter(point => point.x !== null && !isNaN(point.y));

                // Configuración del gráfico
                const options = {
                    series: [{
                        name: 'Utilidad de la Cartera',
                        data: chartData
                    }],
                    chart: {
                        type: 'line',
                        height: 350,
                        toolbar: {
                            show: true
                        },
                        zoom: {
                            enabled: true
                        }
                    },
                    dataLabels: {
                        enabled: false
                    },
                    stroke: {
                        curve: 'smooth',
                        width: 3
                    },
                    colors: ['#10B981'], // Verde por defecto
                    markers: {
                        size: 5,
                        strokeWidth: 0,
                        hover: {
                            size: 7
                        }
                    },
                    xaxis: {
                        type: 'datetime',
                        labels: {
                            datetimeUTC: false,
                            format: 'dd MMM yyyy',
                            style: {
                                colors: '#9CA3AF'
                            }
                        }
                    },
                    yaxis: {
                        labels: {
                            formatter: function(value) {
                                return value.toFixed(2) + '€';
                            },
                            style: {
                                colors: '#9CA3AF'
                            }
                        }
                    },
                    tooltip: {
                        theme: 'dark',
                        x: {
                            format: 'dd MMM yyyy HH:mm'
                        },
                        y: {
                            formatter: function(value) {
                                const sign = value >= 0 ? '+' : '';
                                return sign + value.toFixed(2) + '€';
                            }
                        }
                    },
                    legend: {
                        show: true,
                        position: 'top',
                        horizontalAlign: 'center',
                        labels: {
                            colors: '#9CA3AF'
                        }
                    },
                    grid: {
                        borderColor: '#374151'
                    },
                    annotations: {
                        yaxis: [{
                            y: 0,
                            borderColor: '#6B7280',
                            strokeDashArray: 5,
                            label: {
                                borderColor: '#6B7280',
                                style: {
                                    color: '#fff',
                                    background: '#6B7280'
                                },
                                text: 'Punto de equilibrio'
                            }
                        }]
                    }
                };

                // Renderizar el gráfico
                const chart = new ApexCharts(document.querySelector("#portfolioUtilityChart"), options);
                chart.render();
            })
            .catch(error => {
                console.error('Error cargando datos del gráfico:', error);
                document.getElementById('portfolioUtilityChart').innerHTML = 
                    '<p class="text-center text-red-500 dark:text-red-400 py-8">Error al cargar los datos del gráfico</p>';
            });
    </script>

</body>

</html>